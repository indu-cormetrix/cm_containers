<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <script src="https://unpkg.com/@superset-ui/embedded-sdk"></script>
    <div class="" id="dashboard"></div>
    <script>
        async function getAccessToken() {
            const keycloakUrl = "http://172.18.0.5:8080/realms/cormetrix/protocol/openid-connect/token";
            const clientId = "superset_client";  // Replace with your client ID
            const clientSecret = "9du2YYb4jmp4KYvOSe2DsSGXwtHWwkNw";
            const username = "superset_dashboard";     // Replace with your username
            const password = "test";     // Replace with your password

            const params = new URLSearchParams();
            params.append("grant_type", "password");
            params.append("client_id", clientId);
            params.append("client_secret", clientSecret);
            params.append("username", username);
            params.append("password", password);
            params.append("scope", "openid");

            try {
                const response = await fetch(keycloakUrl, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/x-www-form-urlencoded",
                    },
                    body: params.toString(),
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log("Access Token:", data.access_token);
                return data.access_token; // Return the token
            } catch (error) {
                console.error("Error fetching access token:", error);
                throw error; // Re-throw the error for further handling
            }
        }

        async function fetchGuestTokenFromBackend() {
            try {
                const keycloakToken = await getAccessToken(); // Await the access token
                const response = await fetch('http://localhost:8088/api/v1/security/guest_token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${keycloakToken}`
                    },
                    body: JSON.stringify({
                        user: {
                            username: "stan_lee",
                            first_name: "Stan",
                            last_name: "Lee"
                        },
                        resources: [{
                            type: "dashboard",
                            id: "73dad8a3-61c2-4c85-8f9f-160188191ece"
                        }],
                        rls: []
                    })
                });

                if (!response.ok) {
                    throw new Error(`Error fetching guest token: ${response.status}`);
                }

                const guestTokenData = await response.json(); // Assuming the guest token is returned here
                return guestTokenData.guest_token; // Adjust according to the actual response structure
            } catch (error) {
                console.error("Error fetching guest token:", error);
                throw error; // Re-throw for handling in embedDashboard
            }
        }

        async function embedDashboard() {
            try {
                const guest_token = await fetchGuestTokenFromBackend(); // Await the guest token
                supersetEmbeddedSdk.embedDashboard({
                    id: "73dad8a3-61c2-4c85-8f9f-160188191ece", // given by the Superset embedding UI
                    supersetDomain: "http://172.18.0.5:8088",
                    mountPoint: document.getElementById("dashboard"), // any HTML element that can contain an iframe
                    fetchGuestToken: () => Promise.resolve(guest_token),
                    dashboardUiConfig: { // dashboard UI config: hideTitle, hideTab, hideChartControls, filters.visible, filters.expanded (optional), urlParams (optional)
                        hideTitle: true,
                        filters: {
                            expanded: true,
                        }
                    },
                    // optional additional iframe sandbox attributes
                    iframeSandboxExtras: ['allow-top-navigation', 'allow-popups-to-escape-sandbox']
                });
            } catch (error) {
                console.error("Error embedding dashboard:", error);
            }
        }

        // Start the process to embed the dashboard
        embedDashboard();
    </script>
</body>

</html>
